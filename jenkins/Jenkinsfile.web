pipeline {
  agent any

  environment {
    VENV = 'venv'
    HEADLESS = 'true'
    SCREENSHOTS_ON_SUCCESS = 'false'
    ALLURE_RESULTS = 'reports/allure-results'
    PYTHONPATH = "."
  }

  stages {
    stage('Setup') {
      steps {
        sh '''
          python3 -m venv ${VENV}
          . ${VENV}/bin/activate  # Use dot notation instead of source
          pip install --upgrade pip wheel
          pip install -r requirements.txt
        '''
      }
    }

    stage('Run Web Tests') {
      steps {
        sh '''
          . ${VENV}/bin/activate
          pytest tests/web \
            --alluredir=${ALLURE_RESULTS} \
            -p no:logging \
            -v
        '''
        archiveArtifacts artifacts: '**/logs/*.log', allowEmptyArchive: true
      }
    }

    stage('Publish Allure Report') {
      steps {
        allure([
          includeProperties: false,
          jdk: '',
          results: [[path: "${ALLURE_RESULTS}"]],
          reportBuildPolicy: 'ALWAYS'
        ])
      }
    }
  }

  post {
    always {
      sh 'rm -rf ${VENV} || true'
    }
    failure {
      echo 'Tests failed! Investigate the Allure report.'
    }
  }
}