pipeline {
  agent any

  environment {
    VENV = 'venv'
    ALLURE_RESULTS = 'reports/allure-results'
    HEADLESS = 'true'
    SCREENSHOTS_ON_SUCCESS = 'false' 
  }

  stages {
    stage('Setup Environment') {
      steps {
        sh '''
          # Install required system packages
          sudo apt-get update
          sudo apt-get install -y python3-venv python3-pip xvfb libxss1 libappindicator1 libindicator7
          
          # Clean up any leftover Chrome processes
          pkill -f chrome || true
          pkill -f chromedriver || true
          rm -rf /tmp/chrome-profile-* || true
        '''
      }
    }

    stage('Run Tests') {
      steps {
        sh '''
          python3 -m venv ${VENV}
          . ${VENV}/bin/activate
          pip install -r requirements.txt
          
          # Start virtual display and run tests
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          HEADLESS=true SCREENSHOTS_ON_SUCCESS=false pytest tests/web --alluredir=${ALLURE_RESULTS} -p no:logging -v
        '''
      }
    }

    stage('Publish Report') {
      steps {
        allure([
          includeProperties: false,
          jdk: '',
          results: [[path: "${ALLURE_RESULTS}"]]
        ])
      }
    }
  }

  post {
    always {
      sh '''
        # Cleanup processes and files
        pkill -f Xvfb || true
        pkill -f chrome || true
        rm -rf ${VENV} /tmp/chrome-profile-*
      '''
    }
  }
}